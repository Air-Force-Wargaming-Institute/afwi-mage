# Report Builder Feature - Project Plan

## 1. Goal

To implement a new feature allowing users to design and generate reports with AI assistance (MAGE). Users will define report structures with explicit text sections and sections generated by MAGE based on user instructions and content retrieved from connected vector stores.

## 2. Core Concepts

*   **Report Definition:** A structure (likely JSON) defining the sections of a report.
*   **Sections:** Building blocks of the report.
    *   **Explicit Section:** Contains pre-defined text content (e.g., Title, Header, static paragraph).
    *   **Generative Section:** Contains instructions for MAGE to generate content. MAGE will use these instructions, the connected vector store, and the report content generated so far.
*   **Vector Store Integration:** Users link a report definition to an existing vector store to provide context for generative sections.
*   **Generation Process:** MAGE iteratively processes the report definition section by section, generating Markdown content for generative sections.
*   **UI:** Dedicated interfaces for report creation/management and the design/preview process.
    *   **Main Page:** Split view. Left 1/3 for creating new reports (from templates or custom), Right 2/3 for viewing/managing prior reports.
    *   **Designer/Viewer Modal:** Pop-up window triggered from the main page. Left half for configuration (metadata, vector store) and section design (form-builder style). Right half for live preview and direct editing of the Markdown report.

## 3. Feature Stories (Epics/High-Level Features)

*   **Report Definition Management:**
    *   As a user, I want to create a new report definition from scratch so I can define a custom report structure.
    *   As a user, I want to select from pre-defined templates to quickly start a common report type.
    *   As a user, I want to save my report definitions so I can reuse or modify them later.
    *   As a user, I want to load existing report definitions to continue working on them or generate reports.
*   **Report Structure Design:**
    *   As a user, I want to add sections to my report definition.
    *   As a user, I want to specify the type of each section (Explicit Text or AI Generated).
    *   As a user, I want to input the content for Explicit sections (e.g., titles, fixed text).
    *   As a user, I want to write clear instructions for AI Generated sections.
    *   As a user, I want to easily reorder sections within the report definition using drag-and-drop or similar controls.
    *   As a user, I want to delete sections I no longer need.
*   **AI Integration & Generation:**
    *   As a user, I want to select and link a specific vector store to my report definition to provide context for the AI.
    *   As a user, I want to initiate the report generation process with a single click.
    *   As a user, I want MAGE to generate Markdown-formatted content for the AI Generated sections based on my instructions, the linked vector store, and the preceding report content.
*   **User Interface & Experience:**
    *   As a user, I want a dedicated "Report Builder" entry point in the main application navigation (e.g., Header menu under Agent Portal).
    *   As a user, I want the main Report Builder page to show options for creating new reports (from templates like Executive Summary, BBP, etc., or custom) on the left, and a list/tile view of my prior reports on the right.
    *   As a user, when I choose to create a new report or view/edit a prior one, I want a **new browser window/tab** to open, displaying the report designer.
    *   As a user, I want the **Report Designer Page** to have a two-panel layout: left panel for global report settings (Title, Description, Vector Store) and section-by-section design, resembling a form builder; right panel for live Markdown preview and direct editing.
    *   As a user, I want the right panel to act as a preview area, showing explicit sections initially, and the full Markdown report content once generated.
    *   As a user, I want to be able to directly edit the text content within the right preview panel.
    *   As a user, if I edit content in the preview panel, I want a "Save" button (likely in the page header/toolbar) to commit my changes.
    *   As a user, I want an "Export Report" button (likely in the page header/toolbar) to generate a Microsoft Word document from the final report content.
    *   As a user, I want the list/tile view of prior reports to display key information like Name, Description, Linked Vector Store, and Report Type (Template name or Custom).

## 4. High-Level Implementation Plan & Checklist

**Phase 1: Frontend (`ReportBuilder` Component & Views)**

*   [X] **Navigation:** Add "Report Builder" menu item to **Agent Portal sub-nav**. (`HeaderStyled.js`, `App.js`)
*   [X] **Main Page Component:** Create the main Report Builder page component. (`ReportBuilderMain.js`)
*   [X] **Main Page Layout:** Implement the split layout (1/3 New Report options, 2/3 Prior Reports list).
    *   [X] Create `NewReportOptions.js` file.
    *   [X] Create `PriorReportsList.js` file.
    *   [X] Basic layout implemented in `ReportBuilderMain.js`.
*   [X] **New Report Section:** (`NewReportOptions.js`)
    *   [X] Display predefined template options (Exec Summary, BBP, BP, TP).
    *   [X] Display "Design Custom Report" option.
*   [X] **Prior Reports Section:** (`PriorReportsList.js`)
    *   [X] Implement list/tile view component.
    *   [X] Display placeholders/mock data for prior reports (Name, Desc, Vector Store, Type).
    *   [X] Add click handlers to trigger **opening the designer page in new window**. (`ReportBuilderMain.js`)
*   [X] **Designer Page Component:** Create the dedicated designer page component. (`ReportDesignerPage.js`)
    *   [X] Create `ReportDesignerPage.js` file.
    *   [X] Add routes for the page in `App.js`.
*   [X] **Designer Page Layout:** Implement the two-panel layout with AppBar. (`ReportDesignerPage.js`)
    *   [X] Create `ReportConfigPanel.js` file.
    *   [X] Create `ReportPreviewPanel.js` file.
    *   [X] Basic layout implemented in `ReportDesignerPage.js`.
*   [X] **Left Panel - Configuration:** (`ReportConfigPanel.js`)
    *   [X] Add input fields for Title, Description.
    *   [X] Add dropdown/selector for Global Vector Store (uses mock data).
*   [X] **Left Panel - Section Designer:** (`ReportConfigPanel.js`)
    *   [X] Implement basic list display for sections.
    *   [X] Add "Add Section" button (and "Insert Section Below").
    *   [X] Create section configuration form (type selection [toggle], format selection, content/instructions inputs).
    *   [X] Implement section deletion button.
    *   [X] Implement button-based reordering.
*   [X] **Right Panel - Preview/Editor:** (`ReportPreviewPanel.js`)
    *   [X] Add a Markdown rendering area.
    *   [X] Display mock generated Markdown based on left panel state.
    *   [X] Implement direct text editing capability for the *entire* report preview.
    *   [X] Add Save/Cancel buttons for editing mode.
    *   [X] Add "Export Report" button (non-functional) to page header.
*   [ ] **State Management:** Implement state management within `ReportDesignerPage.js` for the report definition.
*   [X] **API Integration (Mocking):** Define mock API functions within `ReportDesignerPage.js` for loading/saving definitions.

**Phase 2: Backend (`report_service`) Setup & Core Logic**

*   [ ] **Project Setup:** Create a new service/module for `report_service`.
*   [ ] **Data Model:** Define the JSON structure for report definitions (sections, types, content/instructions, vector store link).
*   [ ] **Storage:** Choose and implement storage for report definitions (e.g., JSON files on disk, database).
*   [ ] **API Endpoints (CRUD):**
    *   [ ] `POST /reports` - Create/Save a new report definition.
    *   [ ] `GET /reports` - List saved report definitions.
    *   [ ] `GET /reports/{report_id}` - Load a specific report definition.
    *   [ ] `PUT /reports/{report_id}` - Update an existing report definition.
    *   [ ] `DELETE /reports/{report_id}` - Delete a report definition.
*   [ ] **API Endpoint (Generation):**
    *   [ ] `POST /reports/{report_id}/generate` - Trigger the report generation process.
*   [ ] **MAGE Integration:**
    *   [ ] Implement logic to load a report definition.
    *   [ ] Implement logic to connect to and query the specified vector store (details TBD).
    *   [ ] Implement the iterative generation loop:
        *   [ ] Process explicit sections.
        *   [ ] Construct prompts for MAGE for generative sections (instructions, context, retrieved data).
        *   [ ] Call MAGE API.
        *   [ ] Assemble the final Markdown report.
    *   [ ] Handle potential errors during generation.
*   [ ] **Vector Store Linking:** Determine how vector stores are identified and accessed. Implement API endpoint to list available vector stores for the frontend dropdown.

**Phase 3: Templates & Refinements**

*   [ ] **Template System:**
    *   [ ] Define how templates are stored and managed (likely predefined JSON on backend).
    *   [ ] Implement backend logic to serve templates.
    *   [ ] Connect frontend "New Report" template buttons to load corresponding template structures into the designer page.
*   [ ] **Export to Word:** Implement the backend logic and frontend call for the "Export Report" feature (Markdown to Word conversion).
*   [ ] **Error Handling:** Improve frontend/backend error display and handling.
*   [ ] **Styling:** Apply consistent UI styling.
*   [ ] **Testing:** Add unit and integration tests.

## 5. Open Questions & Discussion Points

*   **Vector Store Querying:** How should MAGE query the vector store for each section? Should the user provide specific query hints alongside instructions, or should MAGE infer the query? (Seems like global store + section instructions is the current plan).
*   **Context Window Management:** How much of the previously generated report content should be passed to MAGE as context for the next section?
*   **Live Preview Mechanism:** What's the best approach for the live preview? Full generation then display, or streaming section-by-section results (requires backend support)? *Current plan uses simulated full generation then display, with edits happening post-generation.*
*   **Storage Scalability:** Is file-based storage sufficient for report definitions, or should a database be used?
*   **Authentication/Authorization:** How will access to report definitions and vector stores be controlled?
*   **UI Component Library:** Which library/components should be used for the designer (e.g., drag-and-drop, Markdown editor/renderer)?
*   **Direct Editing Save:** When a user edits the right panel and clicks "Save", how is this reconciled with the "master" report definition (JSON)? *Current implementation saves the entire edited Markdown locally, overwriting the generated content for that view. It does not modify the underlying section definitions.* Further refinement needed for per-section saving or linking edits back to instructions.
*   **Word Export Library:** What library should be used for Markdown to Word conversion? (e.g., Pandoc).
*   **New Window Data Passing:** How should template information be passed to the new window for creation? (Query params, `window.postMessage`, or initial fetch based on a temporary ID?). *Current implementation doesn't pass template data.* 

---

This plan provides a starting point. Let's discuss these points and refine the approach!
