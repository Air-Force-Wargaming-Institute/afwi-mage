# AFWI-MAGE API Gateway Logging Strategy

## 1. Overview

Comprehensive logging is a critical component of the AFWI-MAGE API Gateway. This document outlines the strategy for collecting, storing, and analyzing logs generated by the Traefik gateway and related services.

## 2. Logging Requirements

| Requirement | Description | Priority |
|-------------|-------------|----------|
| Request Tracking | Each request should have a unique identifier that follows it through all services | High |
| Performance Metrics | Response times, status codes, and throughput metrics should be logged | High |
| Security Events | Authentication attempts, token validations, and security-related events | High |
| Error Reporting | Detailed error information for troubleshooting | High |
| Resource Usage | CPU, memory, and network usage for capacity planning | Medium |
| User Activity | User-specific actions for audit trails | Medium |
| Service Health | Health check results and service status changes | Medium |

## 3. Log Format and Structure

### 3.1 Gateway Access Logs (JSON)

```json
{
  "time": "2023-03-20T14:28:10Z",
  "request_id": "54f97a01-4a79-4204-b39d-b5976e2cb271",
  "client_ip": "192.168.1.10",
  "method": "GET",
  "path": "/api/chat/sessions",
  "query": "limit=10&offset=0",
  "status_code": 200,
  "response_time_ms": 157,
  "response_size_bytes": 2341,
  "user_id": "user-123",
  "user_role": "admin",
  "service": "chat-service",
  "http_version": "1.1",
  "user_agent": "Mozilla/5.0...",
  "referer": "https://app.example.com/dashboard",
  "trace_id": "abcdef123456"
}
```

### 3.2 Gateway Application Logs (JSON)

```json
{
  "time": "2023-03-20T14:28:10Z",
  "level": "error",
  "message": "Circuit breaker tripped for service chat-service",
  "service": "api_gateway",
  "component": "circuit_breaker",
  "error": {
    "type": "ConnectionError",
    "message": "Connection refused",
    "code": "ECONNREFUSED"
  },
  "context": {
    "target_service": "chat-service",
    "request_path": "/api/chat/sessions",
    "request_id": "54f97a01-4a79-4204-b39d-b5976e2cb271"
  }
}
```

### 3.3 Service-specific Logs

Each service should maintain its own logs with a consistent format:

```json
{
  "time": "2023-03-20T14:28:10Z",
  "level": "info",
  "service": "chat-service",
  "message": "Chat session created",
  "request_id": "54f97a01-4a79-4204-b39d-b5976e2cb271",
  "user_id": "user-123",
  "data": {
    "session_id": "sess-456",
    "participant_count": 2
  }
}
```

## 4. Log Collection and Storage

### 4.1 Storage Locations

| Log Type | Storage Location | Retention Policy |
|----------|------------------|------------------|
| Gateway Access Logs | `/var/log/traefik/access.log` | 30 days |
| Gateway Application Logs | `/var/log/traefik/traefik.log` | 30 days |
| Service Logs | `/var/log/{service_name}/{service_name}.log` | 30 days |

### 4.2 Log Rotation

Log rotation will be configured using the following policy:

```yaml
# Logrotate configuration
/var/log/traefik/*.log {
  daily
  rotate 30
  compress
  delaycompress
  missingok
  notifempty
  create 0640 traefik traefik
  postrotate
    docker kill -s USR1 $(docker ps | grep mage_api_gateway | awk '{print $1}')
  endscript
}
```

## 5. Logging Configuration in Traefik

### 5.1 Access Logs Configuration

```yaml
# In traefik.yaml
accessLog:
  filePath: "/var/log/traefik/access.log"
  format: "json"
  fields:
    headers:
      defaultMode: "keep"
      names:
        User-Agent: "keep"
        Authorization: "redact"
        Content-Type: "keep"
        X-User-ID: "keep"
        X-User-Role: "keep"
        X-Request-ID: "keep"
    clientIP: "keep"
    clientPort: "drop"
    requestMethod: "keep"
    requestPath: "keep"
    responseTime: "keep"
    responseStatus: "keep"
    responseSize: "keep"
```

### 5.2 Application Logs Configuration

```yaml
# In traefik.yaml
log:
  level: "INFO"  # DEBUG, INFO, WARN, ERROR, FATAL
  format: "json"
  filePath: "/var/log/traefik/traefik.log"
```

## 6. Request Tracking Implementation

### 6.1 Request ID Middleware

Add a middleware to generate request IDs if not present:

```yaml
# In dynamic_conf.yaml
http:
  middlewares:
    request-id-middleware:
      plugin:
        requestid:
          headerName: "X-Request-ID"
          generate: true  # Generate if not present in the request
```

### 6.2 Request ID Propagation

Configure services to forward the request ID:

```yaml
# In service configuration
labels:
  - "traefik.http.middlewares.forward-request-id.headers.customRequestHeaders.X-Request-ID=X-Request-ID"
  - "traefik.http.routers.service-router.middlewares=forward-request-id@docker"
```

## 7. Log Analysis

### 7.1 Common Queries

| Purpose | Query Example |
|---------|--------------|
| Error Rate | `status_code >= 500` |
| Slow Responses | `response_time_ms > 1000` |
| Auth Failures | `status_code == 401 OR status_code == 403` |
| User Activity | `user_id == "user-123"` |
| Service Health | `status_code >= 500 GROUP BY service` |

### 7.2 Monitoring Alerts

| Alert | Condition | Severity |
|-------|-----------|----------|
| High Error Rate | Error rate > 5% over 5 minutes | High |
| Service Unavailable | 5 consecutive failed health checks | High |
| Slow Response Time | 90th percentile > 2s over 10 minutes | Medium |
| Authentication Spike | Auth failures increase by 200% | Medium |
| Circuit Breaker Tripped | Any circuit breaker activation | Medium |

## 8. Security Considerations

### 8.1 Sensitive Data Handling

The following data will be redacted or obfuscated in logs:

- Authentication tokens
- Passwords
- Personal identifiable information (PII)
- Credit card or financial information
- Session cookies
- API keys

### 8.2 Log Access Controls

| Role | Access Level | Description |
|------|-------------|-------------|
| Platform Admin | Full access | Complete access to all logs |
| Service Admin | Service-specific | Access only to specific service logs |
| Developer | Read-only | Read-only access to non-sensitive logs |
| Security Analyst | Full access | Complete access for security investigations |

## 9. Implementation Steps

1. Configure Traefik access and application logging
2. Set up log volume mounts in docker-compose.yml
3. Implement request ID middleware
4. Configure log rotation
5. Test logging with different request scenarios
6. Verify log retention and rotation

## 10. Future Enhancements

1. Implement centralized log aggregation (ELK stack)
2. Add real-time log analysis dashboard
3. Implement anomaly detection for security events
4. Add correlation between logs from different services
5. Integrate with existing security information and event management (SIEM) system 