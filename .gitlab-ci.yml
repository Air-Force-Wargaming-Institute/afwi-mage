stages:
  - prebuild
  - security_scan
  - compliance
  - quality_gates
  - deploy
  - audit_trail

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  DOCKER_TLS_CERTDIR: ""

prebuild_checks:
  stage: prebuild
  image: python:3.10
  script:
    - set -x
    - python3.10 --version || (echo "Python 3.10 not found" && exit 1)
    - python3.11 --version || (echo "Python 3.11 not found" && exit 1)
    - command -v nvidia-smi || echo "NVIDIA drivers not installed; skipping GPU check"
    - nvidia-smi || echo "nvidia-smi unavailable; proceeding without GPU metrics"
    - mkdir -p app/data/{uploads,extraction,datasets,outputs,logs,temp_conversions,builder/AGENTS,builder/TEAMS}
    - mkdir -p app/models/{base_models,fine_tuned_models}
    - mkdir -p app/nltk_data
    - ls -ld app/data/uploads
  artifacts:
    paths:
      - app/data/logs

security_scan:
  stage: security_scan
  image: python:3.10
  script:
    - set -x
    - pip install bandit safety trufflehog
    - bandit -r . -f json -o sast_report.json || true
    - safety check --json > dependency_check.json || true
    - |
      if python -c "import json; json.load(open('dependency_check.json'))" 2>/dev/null; then 
        python -c "import json, csv; data=json.load(open('dependency_check.json')); csvfile=open('dependency_check.csv','w',newline=''); writer=csv.writer(csvfile); writer.writerow(['package','version']); [writer.writerow([pkg.get('package'), pkg.get('version')]) for pkg in data.get('vulnerabilities',[])]; csvfile.close()"
      else 
        echo "dependency_check.json is not valid JSON, skipping CSV conversion"
        echo "package,version" > dependency_check.csv
      fi
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
    - trivy image --format json --output container_scan.json my-docker-image:latest || true
    - trufflehog filesystem . --json > secret_detection.json || true
  artifacts:
    paths:
      - sast_report.json
      - dependency_check.csv
      - container_scan.json
      - secret_detection.json

compliance:
  stage: compliance
  image: alpine:latest
  script:
    - set -x
    - |
      cat <<'EOF' > direct_chat_healthcheck.yaml
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost:8011/api/v1/health"]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 10s
      EOF
    - |
      cat <<'EOF' > database_healthcheck.yaml
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U postgres"]
        interval: 5s
        timeout: 5s
        retries: 5
      EOF
    - |
      cat <<'EOF' > service_dependencies.yaml
      depends_on:
        condition: service_healthy
      EOF
  artifacts:
    paths:
      - direct_chat_healthcheck.yaml
      - database_healthcheck.yaml
      - service_dependencies.yaml

quality_gates:
  stage: quality_gates
  image: alpine:latest
  dependencies:
    - security_scan  # Removed build_test dependency
  script:
    - set -x
    - |
      if [ -f coverage_report.xml ]; then
        COVERAGE=$(grep -o 'line-rate="[^"]*' coverage_report.xml | head -1 | cut -d'"' -f2 | awk '{printf "%d", $1 * 100}')
        echo "Coverage: ${COVERAGE}%"
        if [ "$COVERAGE" -lt 80 ]; then
          echo "Error: Code coverage is below 80%"; exit 1;
        fi
      else
        echo "Warning: No coverage report found, skipping coverage check."
      fi
    - |
      HIGH_ISSUES=$(jq '.high_severity' sast_report.json)
      echo "High severity issues: $HIGH_ISSUES"
      if [ "$HIGH_ISSUES" -gt 0 ]; then
        echo "Error: High severity security issues found"; exit 1;
      fi

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  only:
    - main
  when: manual
  before_script:
    - until docker info >/dev/null 2>&1; do sleep 3; echo "Waiting for Docker to be ready..."; done
  script:
    - set -x
    - docker-compose up -d
    - echo "Deployment completed successfully"
  environment:
    name: production

audit_trail:
  stage: audit_trail
  image: alpine:latest
  dependencies:
    - prebuild_checks
  script:
    - set -x
    - tar -czf build_logs.tar.gz app/data/logs/
  artifacts:
    paths:
      - build_logs.tar.gz
